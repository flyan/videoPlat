# VideoPlat 问题修复方案

## 问题 1：会议室创建失败 - 活跃会议室数量限制

### 根本原因
- 系统限制最多 10 个并发活跃会议室
- 数据库中可能存在未正确清理的会议室（状态仍为 ACTIVE）
- 缺少自动清理机制

### 修复方案

#### 方案 A：添加定时清理任务（推荐）
在 RoomService 中添加定时任务，自动清理长时间无人的会议室：

```java
@Scheduled(fixedRate = 300000) // 每 5 分钟执行一次
public void cleanupInactiveRooms() {
    LocalDateTime threshold = LocalDateTime.now().minusHours(2);
    List<Room> staleRooms = roomRepository.findByStatusAndCreatedAtBefore(
        RoomStatus.ACTIVE, threshold);

    for (Room room : staleRooms) {
        long activeParticipants = participantRepository
            .countByRoomIdAndLeftAtIsNull(room.getId());
        if (activeParticipants == 0) {
            room.setStatus(RoomStatus.ENDED);
            room.setEndedAt(LocalDateTime.now());
            roomRepository.save(room);
        }
    }
}
```

#### 方案 B：增加管理接口手动清理
添加管理员接口来清理会议室：

```java
@DeleteMapping("/admin/rooms/cleanup")
public ResponseEntity<ApiResponse<Integer>> cleanupRooms() {
    int cleaned = roomService.cleanupInactiveRooms();
    return ResponseEntity.ok(ApiResponse.success("已清理 " + cleaned + " 个会议室", cleaned));
}
```

#### 方案 C：提高并发限制（临时方案）
修改配置文件，将限制从 10 提高到 50：

```yaml
app:
  room:
    max-concurrent-rooms: 50
```

---

## 问题 2：录制记录 API 不存在

### 根本原因
- 旧代码中的 RecordingController 在 `backend/src` 目录
- 新的模块化代码中没有包含录制功能
- Docker 运行的是新代码，所以录制 API 不可用

### 修复方案

#### 步骤 1：创建录制模块或将录制功能集成到现有模块

选项 A：创建独立的 `videoplat-recording` 模块
选项 B：将录制功能集成到 `videoplat-meeting` 模块

推荐选项 B，因为录制与会议紧密相关。

#### 步骤 2：迁移代码

需要迁移的文件：
- `RecordingController.java`
- `RecordingService.java`
- `Recording.java` (实体)
- `RecordingRepository.java`
- `RecordingDto.java`

目标位置：`backend/videoplat-meeting/src/main/java/com/videoplat/meeting/`

#### 步骤 3：更新路由

确保 Controller 的 `@RequestMapping` 正确：
```java
@RestController
@RequestMapping("/api/recordings")
public class RecordingController {
    // ...
}
```

---

## 问题 3：重新加入会议无响应

### 根本原因
需要检查前端代码，可能的原因：
1. 点击事件处理函数未正确绑定
2. 会议室 ID 获取失败
3. 缺少错误处理和用户反馈

### 修复方案

检查 `frontend/src/pages/Home.jsx` 中的"重新加入"按钮逻辑：

```javascript
const handleRejoinRoom = async (roomId) => {
  try {
    // 检查会议室是否存在
    const response = await api.get(`/rooms/${roomId}`);
    if (response.data.success) {
      navigate(`/room/${roomId}`);
    }
  } catch (error) {
    message.error('会议室不存在或已结束');
  }
};
```

---

## 修复优先级

### 高优先级（立即修复）
1. ✅ 添加定时清理任务（问题 1 - 方案 A）
2. ✅ 迁移录制功能到新模块（问题 2）

### 中优先级（本周内）
3. ✅ 修复重新加入会议逻辑（问题 3）
4. ✅ 添加管理接口清理会议室（问题 1 - 方案 B）

### 低优先级（优化）
5. 提高并发限制配置（问题 1 - 方案 C）
6. 添加会议室自动过期机制

---

## 实施步骤

### 第一步：修复会议室清理问题

1. 在 `RoomService.java` 中添加 `@EnableScheduling` 注解
2. 添加定时清理方法
3. 重启后端服务
4. 测试创建会议室功能

### 第二步：迁移录制功能

1. 在 `videoplat-meeting` 模块中创建 `recording` 包
2. 复制并调整录制相关代码
3. 更新依赖和导入
4. 重新编译和部署
5. 测试录制列表 API

### 第三步：修复前端问题

1. 检查 Home.jsx 中的事件处理
2. 添加错误处理和用户提示
3. 测试重新加入功能

---

## 测试计划

修复后需要测试：

1. **会议室功能**
   - ✅ 创建会议室
   - ✅ 加入会议室
   - ✅ 离开会议室
   - ✅ 结束会议室
   - ✅ 自动清理无人会议室

2. **录制功能**
   - ✅ 获取录制列表
   - ✅ 播放录制
   - ✅ 下载录制
   - ✅ 删除录制

3. **前端功能**
   - ✅ 重新加入会议
   - ✅ 错误提示显示

---

生成时间：2026-02-08
状态：待实施
