# 录制功能说明文档

## 📋 当前状态

### ✅ 已实现的功能

1. **录制 API 接口** - 完整实现
   - 开始录制
   - 停止录制
   - 查看录制列表
   - 查看录制详情
   - 播放录制
   - 删除录制

2. **数据库记录** - 正常工作
   - 录制元数据保存
   - 录制状态管理
   - 录制时间记录

3. **权限控制** - 已实现
   - 只有主持人可以开始录制
   - 只有创建者可以删除录制

---

### ⚠️ 待实现的功能

**Agora 云端录制集成** - 需要开发

当前录制功能只是创建了数据库记录，但**没有实际录制音视频**。

**原因：**
- 需要集成 Agora 云端录制 API
- 需要配置 Agora 云端录制服务
- 需要处理录制文件的上传和存储

---

## 🎥 录制文件位置

### 当前配置

**容器内路径：** `/app/recordings/`
**宿主机路径：** Docker Volume `recordings_data`

### 查看录制文件

```bash
# 查看容器内的录制文件
docker exec videoplat-backend ls -lh /app/recordings/

# 查看 Docker Volume
docker volume inspect videoplat_recordings_data

# 进入容器查看
docker exec -it videoplat-backend sh
cd /app/recordings
ls -lh
```

---

## 🔧 为什么没有录制文件？

### 当前实现

```java
@Transactional
public RecordingDto startRecording(String roomId, Long userId) {
    // ... 验证逻辑 ...

    // 生成录制文件路径
    String filePath = storagePath + File.separator + fileName;

    // 保存录制记录到数据库
    Recording recording = Recording.builder()
            .roomId(room.getId())
            .roomName(room.getRoomName())
            .filePath(filePath)
            .resolution("1280x720")
            .creatorId(userId)
            .build();

    recording = recordingRepository.save(recording);

    // TODO: 调用 Agora 云端录制 API 开始录制
    // 这里需要集成 Agora 云端录制服务 ⚠️

    return convertToDto(recording);
}
```

**关键点：**
- ✅ 数据库记录已创建
- ❌ 实际录制未开始（TODO 部分）
- ❌ 没有调用 Agora API
- ❌ 没有生成录制文件

---

## 🚀 如何实现真实录制？

### 方案 1：集成 Agora 云端录制（推荐）

**步骤：**

1. **添加 Agora 云端录制 SDK**

```xml
<!-- pom.xml -->
<dependency>
    <groupId>io.agora</groupId>
    <artifactId>agora-cloud-recording</artifactId>
    <version>1.0.0</version>
</dependency>
```

2. **配置 Agora 云端录制**

```yaml
# application.yml
agora:
  app-id: ${AGORA_APP_ID}
  app-certificate: ${AGORA_APP_CERTIFICATE}
  cloud-recording:
    customer-id: ${AGORA_CUSTOMER_ID}
    customer-secret: ${AGORA_CUSTOMER_SECRET}
    region: cn
    bucket: your-s3-bucket
```

3. **实现录制服务**

```java
@Service
public class AgoraCloudRecordingService {

    public String startRecording(String channelName, String uid) {
        // 1. 获取 Resource ID
        String resourceId = acquireResource(channelName, uid);

        // 2. 开始录制
        String sid = startCloudRecording(resourceId, channelName, uid);

        return sid;
    }

    public void stopRecording(String resourceId, String sid) {
        // 停止云端录制
        stopCloudRecording(resourceId, sid);
    }
}
```

4. **更新 RecordingService**

```java
@Transactional
public RecordingDto startRecording(String roomId, Long userId) {
    // ... 现有逻辑 ...

    // 调用 Agora 云端录制
    String sid = agoraCloudRecordingService.startRecording(
        roomId,  // 频道名
        userId.toString()  // 用户 ID
    );

    recording.setAgoraSid(sid);
    recording = recordingRepository.save(recording);

    return convertToDto(recording);
}
```

**参考文档：**
- [Agora 云端录制快速开始](https://docs.agora.io/cn/cloud-recording/get-started/getstarted)
- [Agora 云端录制 RESTful API](https://docs.agora.io/cn/cloud-recording/restfulapi)

---

### 方案 2：客户端录制（简单但不推荐）

**步骤：**

1. **前端使用 MediaRecorder API**

```javascript
// 在会议室页面
const startRecording = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  const mediaRecorder = new MediaRecorder(stream);
  const chunks = [];

  mediaRecorder.ondataavailable = (e) => {
    chunks.push(e.data);
  };

  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    // 上传到服务器
    await uploadRecording(blob);
  };

  mediaRecorder.start();
};
```

**缺点：**
- 只能录制本地视频
- 无法录制其他参与者
- 文件较大
- 浏览器兼容性问题

---

### 方案 3：使用第三方录制服务

**选项：**
- AWS Kinesis Video Streams
- Azure Media Services
- 腾讯云实时音视频录制
- 阿里云音视频通信录制

---

## 📊 当前录制流程

### 开始录制

```
用户点击"开始录制"
    ↓
前端调用 API: POST /api/rooms/{roomId}/recordings/start
    ↓
后端验证权限和会议室状态
    ↓
生成录制文件路径
    ↓
保存录制记录到数据库 ✅
    ↓
TODO: 调用 Agora 云端录制 API ❌
    ↓
返回录制信息给前端
```

### 停止录制

```
用户点击"停止录制"
    ↓
前端调用 API: POST /api/rooms/{roomId}/recordings/stop
    ↓
后端查找当前录制
    ↓
更新结束时间 ✅
    ↓
TODO: 调用 Agora API 停止录制 ❌
    ↓
TODO: 获取录制文件 ❌
    ↓
返回成功消息
```

---

## 🔍 查看录制记录

### 方法 1：通过 API

```bash
# 获取 token
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

# 查看录制列表
curl -X GET "http://localhost:8080/api/recordings" \
  -H "Authorization: Bearer $TOKEN"
```

### 方法 2：直接查询数据库

```bash
# 连接到数据库
docker exec -it videoplat-backend sh

# 查询录制记录
psql $DATABASE_URL -c "SELECT * FROM recordings ORDER BY started_at DESC LIMIT 10;"
```

---

## 💡 临时解决方案

如果你想测试录制功能，可以：

### 1. 手动创建测试文件

```bash
# 进入容器
docker exec -it videoplat-backend sh

# 创建测试录制文件
cd /app/recordings
echo "This is a test recording file" > test_recording.mp4

# 查看文件
ls -lh
```

### 2. 使用屏幕录制工具

- **Windows:** Xbox Game Bar (Win + G)
- **Mac:** QuickTime Player
- **Linux:** SimpleScreenRecorder

录制后手动上传到服务器。

---

## 📝 下一步计划

### 短期（本周）

1. ✅ 修复录制列表查询 SQL 问题
2. ⏸️ 集成 Agora 云端录制 API
3. ⏸️ 实现录制文件下载

### 中期（本月）

1. ⏸️ 录制文件自动上传到云存储
2. ⏸️ 录制文件转码和压缩
3. ⏸️ 录制文件预览功能

### 长期（下个月）

1. ⏸️ 录制文件自动清理
2. ⏸️ 录制文件分享功能
3. ⏸️ 录制文件权限管理

---

## 🎯 总结

### 当前状态

- ✅ **API 接口：** 完整实现
- ✅ **数据库记录：** 正常工作
- ✅ **权限控制：** 已实现
- ❌ **实际录制：** 未实现（需要集成 Agora）
- ❌ **录制文件：** 不存在

### 为什么没有文件？

因为当前只是创建了录制的**元数据记录**，但没有实际调用 Agora 云端录制 API 来录制音视频。

### 如何获得真实录制？

需要集成 Agora 云端录制服务，这需要：
1. 注册 Agora 云端录制服务
2. 配置存储桶（S3/OSS）
3. 实现 Agora 云端录制 API 调用
4. 处理录制文件的下载和存储

---

**文档生成时间：** 2026-02-08 14:35
**状态：** 录制功能部分实现
**下一步：** 集成 Agora 云端录制
