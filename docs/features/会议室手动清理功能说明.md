# 会议室手动清理功能使用说明

## 功能概述

新增了两个手动清理会议室的 API 接口，方便管理员在需要时立即清理会议室，解决"会议室数量已达上限"的问题。

---

## API 接口

### 1. 手动清理无人会议室

**接口地址：** `POST /api/rooms/cleanup`

**功能说明：**
- 清理所有无人的活跃会议室
- 不受时间限制（自动清理需要会议室创建超过 2 小时）
- 只清理无人的会议室，不影响正在进行的会议

**请求示例：**
```bash
curl -X POST http://localhost:8080/api/rooms/cleanup \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**响应示例：**
```json
{
  "success": true,
  "message": "已清理 5 个无人会议室",
  "data": 5
}
```

**使用场景：**
- 会议室数量达到上限，无法创建新会议室
- 需要立即释放无人会议室资源
- 系统维护前清理无效会议室

---

### 2. 强制清理所有会议室

**接口地址：** `POST /api/rooms/cleanup/force`

**功能说明：**
- 强制结束所有活跃会议室
- 包括有人的会议室也会被强制结束
- 所有参与者将被移出会议室
- ⚠️ **谨慎使用！** 会中断正在进行的会议

**请求示例：**
```bash
curl -X POST http://localhost:8080/api/rooms/cleanup/force \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**响应示例：**
```json
{
  "success": true,
  "message": "已强制清理 10 个会议室",
  "data": 10
}
```

**使用场景：**
- 系统紧急维护
- 需要立即释放所有资源
- 测试环境重置

---

## 使用方法

### 方法 1：使用 curl 命令

1. **获取 JWT Token**
```bash
# 登录获取 token
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 响应中的 token 字段就是 JWT Token
```

2. **调用清理接口**
```bash
# 手动清理无人会议室
curl -X POST http://localhost:8080/api/rooms/cleanup \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."

# 强制清理所有会议室
curl -X POST http://localhost:8080/api/rooms/cleanup/force \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

### 方法 2：使用 Swagger UI

1. 访问 Swagger UI：http://localhost:8080/swagger-ui.html
2. 点击右上角 "Authorize" 按钮
3. 输入 JWT Token（格式：`Bearer YOUR_TOKEN`）
4. 找到 "会议室" 分组
5. 展开 `POST /api/rooms/cleanup` 或 `POST /api/rooms/cleanup/force`
6. 点击 "Try it out" 按钮
7. 点击 "Execute" 执行

### 方法 3：使用 Postman

1. 创建新请求
2. 方法：POST
3. URL：`http://localhost:8080/api/rooms/cleanup`
4. Headers：
   - Key: `Authorization`
   - Value: `Bearer YOUR_JWT_TOKEN`
5. 点击 Send

---

## 清理策略对比

| 清理方式 | 触发条件 | 清理范围 | 时间限制 | 影响 |
|---------|---------|---------|---------|------|
| **自动清理** | 每 5 分钟 | 无人会议室 | 创建超过 2 小时 | 无影响 |
| **手动清理** | 管理员调用 | 无人会议室 | 无限制 | 无影响 |
| **强制清理** | 管理员调用 | 所有会议室 | 无限制 | ⚠️ 中断会议 |

---

## 日志查看

清理操作会记录详细日志，可以通过以下命令查看：

```bash
# 查看所有清理日志
docker-compose logs backend | grep "清理"

# 查看手动清理日志
docker-compose logs backend | grep "手动清理"

# 查看强制清理日志
docker-compose logs backend | grep "强制清理"
```

**日志示例：**
```
手动清理会议室: 测试会议室 (abc123), 创建时间: 2026-02-08T10:00:00, 持续时间: 15 分钟
手动清理完成，共清理 5 个无人会议室

强制清理会议室: 团队周会 (def456), 参与者数量: 3
强制清理完成，共清理 10 个会议室
```

---

## 权限说明

目前这两个接口需要登录后才能调用，建议后续添加管理员权限验证：

```java
@PreAuthorize("hasRole('ADMIN')")
@PostMapping("/cleanup")
public ResponseEntity<ApiResponse<Integer>> manualCleanup() {
    // ...
}
```

---

## 测试步骤

### 测试手动清理功能

1. **创建测试会议室**
```bash
# 登录
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.data.token')

# 创建会议室
curl -X POST http://localhost:8080/api/rooms \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"roomName":"测试会议室1","maxParticipants":10}'
```

2. **查看活跃会议室数量**
```bash
curl -X GET http://localhost:8080/api/v1/admin/rooms/active \
  -H "Authorization: Bearer $TOKEN"
```

3. **手动清理**
```bash
curl -X POST http://localhost:8080/api/rooms/cleanup \
  -H "Authorization: Bearer $TOKEN"
```

4. **验证清理结果**
```bash
# 再次查看活跃会议室数量
curl -X GET http://localhost:8080/api/v1/admin/rooms/active \
  -H "Authorization: Bearer $TOKEN"

# 查看日志
docker-compose logs backend | grep "手动清理"
```

---

## 常见问题

### Q1: 为什么手动清理返回 0？
**A:** 可能所有会议室都有参与者在线。手动清理只清理无人的会议室。

### Q2: 强制清理会影响用户吗？
**A:** 是的，强制清理会立即结束所有会议，包括正在进行的会议。用户会被踢出会议室。

### Q3: 清理后会议室数据会丢失吗？
**A:** 不会。会议室记录仍然保存在数据库中，只是状态变为 ENDED。

### Q4: 可以恢复被清理的会议室吗？
**A:** 不可以。会议室一旦结束就无法恢复，需要重新创建。

### Q5: 自动清理和手动清理有什么区别？
**A:**
- 自动清理：每 5 分钟执行，只清理创建超过 2 小时且无人的会议室
- 手动清理：立即执行，清理所有无人的会议室，不受时间限制

---

## 后续优化建议

1. **添加管理员权限验证**
   - 只允许管理员调用清理接口
   - 使用 `@PreAuthorize("hasRole('ADMIN')")`

2. **添加清理确认机制**
   - 强制清理前需要二次确认
   - 返回将要清理的会议室列表

3. **添加清理历史记录**
   - 记录每次清理的时间、操作人、清理数量
   - 提供清理历史查询接口

4. **添加前端管理界面**
   - 在管理台添加清理按钮
   - 显示当前活跃会议室列表
   - 提供一键清理功能

5. **添加通知机制**
   - 强制清理前通知参与者
   - 清理后发送邮件通知

---

## 部署说明

功能已部署到后端服务，无需额外配置。

**部署时间：** 2026-02-08 14:02
**版本：** v0.1.0
**状态：** ✅ 已上线

---

**文档更新时间：** 2026-02-08 14:03
**作者：** Claude
