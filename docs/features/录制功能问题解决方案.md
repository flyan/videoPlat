# 录制功能问题解决方案

## 🔍 问题原因

你遇到的 `401 Unauthorized` 错误是因为：

1. **.env 文件缺少 `RECORDING_MODE` 配置**
   - 系统默认使用云端录制模式
   - 云端录制需要配置云存储，否则会认证失败

2. **Docker 镜像还没有包含 Agora 录制程序**
   - 需要重新构建 Docker 镜像

---

## ✅ 已完成的修复

### 1. 更新 .env 配置

已添加以下配置：
```bash
RECORDING_MODE=local  # 使用本地录制
RECORDER_BIN_PATH=/app/agora_recorder/recorder_local
RECORDING_STORAGE_PATH=/app/recordings
```

### 2. 修复编译错误

修复了 `AdminRoomController.java` 中的类型错误。

### 3. 重新构建 Docker 镜像

正在后台构建包含 Agora 录制程序的 Docker 镜像。

---

## ⏳ 等待构建完成

### 查看构建进度

```bash
# 方法 1：查看 Docker 构建日志
docker ps -a | grep build

# 方法 2：查看后台任务输出
# 任务 ID: b1f6422
```

### 预计时间

- **首次构建**：5-10 分钟
- **后续构建**：2-3 分钟（使用缓存）

构建过程包括：
1. Maven 构建 Spring Boot 应用（约 2 分钟）
2. 编译 Agora 录制程序（约 3-5 分钟）
3. 整合所有组件（约 1 分钟）

---

## 🚀 构建完成后的操作

### 步骤 1：重启服务

```bash
cd E:/file/program/claude/videoPlat
docker-compose up -d
```

### 步骤 2：验证部署

```bash
# 检查录制程序
docker exec videoplat-backend ls -la /app/agora_recorder/

# 应该看到：
# -rwxr-xr-x 1 root root recorder_local

# 检查库文件
docker exec videoplat-backend ls -la /usr/local/lib/

# 应该看到：
# libagora-fdkaac.so
# libagora_rtc_sdk.so
# libaosl.so
```

### 步骤 3：测试录制

1. 打开浏览器：https://localhost
2. 登录系统
3. 创建会议室
4. 点击"开始录制"
5. 等待 30 秒
6. 点击"停止录制"
7. 检查录制文件：
   ```bash
   docker exec videoplat-backend ls -lh /app/recordings/
   ```

---

## 📊 本地录制 vs 云端录制

| 特性 | 本地录制（当前配置） | 云端录制 |
|------|---------------------|---------|
| 录制位置 | 服务器端 | Agora 云端 |
| 混流支持 | ✅ 支持 | ✅ 支持 |
| 文件存储 | 本地磁盘 | 云存储（OSS/S3） |
| 配置复杂度 | ⭐⭐ 简单 | ⭐⭐⭐⭐ 复杂 |
| 云存储费用 | 无 | 有 |
| 认证问题 | 无 | 需要配置 |
| 适用场景 | 开发/生产 | 生产环境 |

---

## 🔧 如果构建失败

### 检查错误日志

```bash
# 查看构建日志
docker-compose build backend 2>&1 | tee build.log

# 查看最后 50 行
tail -50 build.log
```

### 常见问题

#### 1. Maven 构建失败

**解决方法：**
```bash
# 清理 Maven 缓存
docker-compose build --no-cache backend
```

#### 2. Agora SDK 目录不存在

**检查：**
```bash
ls -la E:/file/program/claude/videoPlat/backend/agora_rtc_sdk/
```

**如果不存在，重新复制：**
```bash
cp -r E:/file/program/claude/tools/agora_rtc_sdk E:/file/program/claude/videoPlat/backend/
```

#### 3. 编译工具缺失

**错误信息：** `cmake: command not found`

**解决方法：** Dockerfile 已包含编译工具安装，重新构建即可。

---

## 💡 临时解决方案（如果不想等待）

如果你不想等待构建完成，可以暂时使用云端录制，但需要配置云存储：

### 配置云端录制

1. 修改 `.env` 文件：
   ```bash
   RECORDING_MODE=cloud

   # 配置阿里云 OSS 或 AWS S3
   CLOUD_STORAGE_ACCESS_KEY=你的_ACCESS_KEY
   CLOUD_STORAGE_SECRET_KEY=你的_SECRET_KEY
   ```

2. 重启服务：
   ```bash
   docker-compose restart backend
   ```

**注意：** 云端录制需要云存储费用，建议使用本地录制。

---

## 📚 相关文档

- **完整文档：** `Agora本地录制集成完成报告.md`
- **快速开始：** `本地录制快速开始.md`
- **API 文档：** http://localhost:8080/swagger-ui.html

---

## 🆘 需要帮助？

如果遇到问题，请提供：
1. 构建日志（最后 50 行）
2. 错误信息截图
3. `.env` 文件内容（隐藏敏感信息）

---

**当前状态：** ⏳ 正在构建 Docker 镜像
**预计完成时间：** 5-10 分钟
**下一步：** 等待构建完成后重启服务
