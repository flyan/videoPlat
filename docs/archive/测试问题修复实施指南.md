# VideoPlat 测试问题修复实施指南

## 📊 问题诊断结果

### 根本原因
当前 Docker 容器运行的是**旧版单体应用**，而不是新的模块化应用。

**证据**：
- Docker 容器 `videoplat-backend` 正在运行
- 旧的 Dockerfile 只复制了 `backend/src`，没有包含新的子模块
- 所有新增 API（管理台、视频调阅）返回 500 错误
- 测试通过率仅 15.4%（2/13）

### 影响范围
- ❌ 管理台所有功能（`/api/v1/admin/**`）
- ❌ 视频调阅所有功能（`/api/v1/video-review/**`）
- ❌ WebSocket 在线状态管理
- ❌ 新增数据库字段（role, online_status, last_active_at）

---

## 🔧 修复步骤

### 步骤 1：更新 Dockerfile ✅

**已完成**：Dockerfile 已更新为支持模块化构建。

主要变更：
- 复制所有子模块的 POM 文件
- 复制所有子模块的源代码
- 从 `videoplat-application/target/` 复制最终的 JAR 文件

### 步骤 2：停止当前容器

```bash
# 停止并删除旧容器
docker-compose down

# 或者只停止后端容器
docker stop videoplat-backend
docker rm videoplat-backend
```

### 步骤 3：重新构建镜像

```bash
# 清理旧镜像（可选）
docker rmi videoplat-backend

# 重新构建所有服务
docker-compose build --no-cache

# 或者只构建后端
docker-compose build --no-cache backend
```

**预计时间**：5-10 分钟（取决于网络速度）

### 步骤 4：启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看启动日志
docker-compose logs -f backend
```

**关键日志检查**：
```
✅ videoplat-common 模块加载
✅ videoplat-domain 模块加载
✅ videoplat-auth 模块加载
✅ videoplat-meeting 模块加载
✅ videoplat-admin 模块加载 ⭐ 新增
✅ videoplat-video-review 模块加载 ⭐ 新增
✅ Flyway 迁移执行成功
✅ 数据初始化完成
✅ Started VideoplatApplication in X seconds
```

### 步骤 5：验证服务

```bash
# 1. 健康检查
curl http://localhost:8080/actuator/health

# 2. 管理员登录
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 保存返回的 token
TOKEN="<返回的token>"

# 3. 测试管理台 API（应该返回 200 而不是 500）
curl http://localhost:8080/api/v1/admin/statistics \
  -H "Authorization: Bearer $TOKEN"

# 4. 测试视频调阅 API（应该返回 200 而不是 500）
curl http://localhost:8080/api/v1/video-review/recordings \
  -H "Authorization: Bearer $TOKEN"
```

### 步骤 6：运行完整测试

```bash
# 运行自动化测试脚本
bash test-all-apis.sh
```

**预期结果**：
```
==========================================
测试总结
==========================================

通过: 13
失败: 0
总计: 13

✅ 所有测试通过！
```

---

## 🐛 其他问题修复

### 问题 2：JSON 编码错误

**修复方案 1：配置 Spring Boot（推荐）**

编辑 `backend/videoplat-application/src/main/resources/application.yml`：

```yaml
spring:
  http:
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  jackson:
    charset: UTF-8
```

**修复方案 2：修改测试脚本（临时）**

在 `test-all-apis.sh` 中，将游客登录测试改为：

```bash
# 使用英文昵称
GUEST_RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/guest" \
  -H "Content-Type: application/json; charset=UTF-8" \
  -d '{"nickname":"TestGuest"}')
```

### 问题 3：Room ID 提取问题

需要先查看实际响应格式：

```bash
# 创建会议室并查看完整响应
curl -X POST http://localhost:8080/api/rooms \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"roomName":"Test Room","maxParticipants":10}' | jq .
```

根据实际响应调整测试脚本中的正则表达式。

---

## 📋 验证清单

### 后端服务验证
- [ ] Docker 容器成功启动
- [ ] 健康检查返回 UP
- [ ] 日志中显示所有模块加载成功
- [ ] Flyway 迁移执行成功
- [ ] 默认管理员账号创建成功

### API 功能验证
- [ ] 管理员登录成功（200）
- [ ] 普通用户登录成功（200）
- [ ] 游客登录成功（200）
- [ ] 获取系统统计成功（200）
- [ ] 获取用户列表成功（200）
- [ ] 获取在线用户成功（200）
- [ ] 获取会议室列表成功（200）
- [ ] 获取录制列表成功（200）
- [ ] 权限控制正确（403）

### 前端功能验证
- [ ] 访问 https://192.168.10.9 或 https://localhost
- [ ] 登录页面正常显示
- [ ] 管理员登录后可访问管理台
- [ ] 管理台各页面正常显示
- [ ] 用户管理功能正常
- [ ] 会议室管理功能正常
- [ ] 录制管理功能正常

---

## 🚨 常见问题排查

### 问题：Docker 构建失败

**可能原因**：
- Maven 依赖下载失败
- 网络连接问题
- 磁盘空间不足

**解决方案**：
```bash
# 清理 Docker 缓存
docker system prune -a

# 检查磁盘空间
df -h

# 重新构建
docker-compose build --no-cache backend
```

### 问题：容器启动后立即退出

**排查步骤**：
```bash
# 查看容器日志
docker logs videoplat-backend

# 查看容器状态
docker ps -a

# 进入容器检查
docker exec -it videoplat-backend sh
```

**常见原因**：
- 数据库连接失败（检查 DATABASE_URL）
- Redis 连接失败（检查 REDIS_HOST）
- 环境变量缺失（检查 .env 文件）
- 端口冲突（检查 8080 端口）

### 问题：API 返回 500 错误

**排查步骤**：
```bash
# 查看实时日志
docker-compose logs -f backend

# 检查数据库连接
docker exec videoplat-backend wget -O- http://localhost:8080/actuator/health

# 检查 Swagger UI
curl http://localhost:8080/swagger-ui.html
```

### 问题：前端无法连接后端

**检查项**：
- [ ] 后端容器是否运行：`docker ps`
- [ ] 后端健康检查：`curl http://localhost:8080/actuator/health`
- [ ] CORS 配置是否正确
- [ ] 前端 API_BASE_URL 配置是否正确

---

## 📊 预期结果

### 测试通过率
- **修复前**：15.4%（2/13）
- **修复后**：100%（13/13）

### 功能可用性
| 功能模块 | 修复前 | 修复后 |
|---------|--------|--------|
| 认证功能 | 66% | 100% |
| 会议室功能 | 0% | 100% |
| 管理台功能 | 0% | 100% |
| 视频调阅功能 | 0% | 100% |

### 性能指标
- API 响应时间：< 100ms
- 容器启动时间：< 60s
- 内存使用：< 512MB

---

## 📝 后续工作

### 立即执行
1. ✅ 更新 Dockerfile（已完成）
2. ⏳ 重新构建 Docker 镜像
3. ⏳ 启动服务并验证
4. ⏳ 运行完整测试

### 短期优化
1. 修复 JSON 编码问题
2. 优化测试脚本
3. 添加更多测试用例
4. 完善错误处理

### 长期改进
1. 添加自动化 CI/CD
2. 添加性能监控
3. 添加日志聚合
4. 添加告警机制

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. Docker 容器日志：`docker logs videoplat-backend`
2. 构建日志：`docker-compose build backend`
3. 测试脚本输出：`bash test-all-apis.sh`
4. 环境配置：`.env` 文件内容（隐藏敏感信息）

---

**文档创建时间**：2026-02-08
**最后更新**：2026-02-08
**状态**：待执行
**预计修复时间**：15-20 分钟
