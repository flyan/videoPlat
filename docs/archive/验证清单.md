# VideoPlat 模块化重构验证清单

## 编译验证

### 后端编译
```bash
cd backend
mvn clean install -DskipTests
```

预期结果：
- ✅ 所有模块编译成功
- ✅ 生成 JAR 文件在各模块的 target 目录

### 前端编译
```bash
cd frontend
npm install
npm run build
```

预期结果：
- ✅ 依赖安装成功
- ✅ 构建成功，生成 dist 目录

## 模块依赖验证

### 检查模块依赖关系
```bash
cd backend
mvn dependency:tree
```

预期依赖关系：
```
videoplat-application
├── videoplat-auth
│   ├── videoplat-common
│   └── videoplat-domain
│       └── videoplat-common
├── videoplat-meeting
│   ├── videoplat-common
│   └── videoplat-domain
├── videoplat-admin
│   ├── videoplat-common
│   ├── videoplat-domain
│   └── videoplat-meeting
└── videoplat-video-review
    ├── videoplat-common
    └── videoplat-domain
```

## 数据库验证

### 1. 创建数据库
```sql
CREATE DATABASE videoplat;
```

### 2. 检查 Flyway 迁移
启动应用后，检查 `flyway_schema_history` 表：
```sql
SELECT * FROM flyway_schema_history;
```

预期结果：
- ✅ V1__init_schema.sql 执行成功
- ✅ V2__add_admin_features.sql 执行成功

### 3. 验证表结构
```sql
-- 检查 users 表新增字段
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'users'
AND column_name IN ('role', 'online_status', 'last_active_at');

-- 检查 admin_operation_logs 表
SELECT * FROM information_schema.tables
WHERE table_name = 'admin_operation_logs';
```

预期结果：
- ✅ users 表包含 role, online_status, last_active_at 字段
- ✅ admin_operation_logs 表存在

## 功能验证

### 1. 启动应用
```bash
cd backend/videoplat-application
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

预期结果：
- ✅ 应用启动成功
- ✅ 端口 8080 监听
- ✅ 数据初始化完成（创建管理员账号）
- ✅ 日志中显示所有模块加载成功

### 2. 访问 Swagger UI
访问：http://localhost:8080/swagger-ui.html

预期结果：
- ✅ Swagger UI 页面加载成功
- ✅ 显示所有 API 端点分组：
  - Auth Controller
  - User Controller
  - Room Controller
  - Admin User Controller
  - Admin Room Controller
  - Admin Monitor Controller
  - Admin Operation Log Controller
  - Video Review Controller

### 3. 测试认证功能

#### 3.1 管理员登录
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回 JWT Token
- ✅ 返回用户信息（role: ADMIN）

#### 3.2 普通用户登录
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "password": "user123"
  }'
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回 JWT Token
- ✅ 返回用户信息（role: USER）

### 4. 测试管理台功能

#### 4.1 获取系统统计（需要管理员权限）
```bash
curl -X GET http://localhost:8080/api/v1/admin/statistics \
  -H "Authorization: Bearer {admin_token}"
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回系统统计信息（用户数、会议室数等）

#### 4.2 获取用户列表
```bash
curl -X GET "http://localhost:8080/api/v1/admin/users?page=0&size=20" \
  -H "Authorization: Bearer {admin_token}"
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回用户列表（分页）
- ✅ 包含 role 和 online_status 字段

#### 4.3 非管理员访问管理台（应该失败）
```bash
curl -X GET http://localhost:8080/api/v1/admin/statistics \
  -H "Authorization: Bearer {user_token}"
```

预期结果：
- ✅ 返回 403 状态码（Forbidden）
- ✅ 错误信息：权限不足

### 5. 测试会议室功能

#### 5.1 创建会议室
```bash
curl -X POST http://localhost:8080/api/rooms \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "roomName": "测试会议室",
    "maxParticipants": 10
  }'
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回会议室信息（包含 roomId）

#### 5.2 加入会议室
```bash
curl -X POST http://localhost:8080/api/rooms/{roomId}/join \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{}'
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回 Agora Token

### 6. 测试 WebSocket 连接

使用浏览器控制台或 WebSocket 客户端：
```javascript
const ws = new WebSocket('ws://localhost:8080/ws/meeting?userId=1');

ws.onopen = () => {
  console.log('WebSocket 连接成功');
};

ws.onmessage = (event) => {
  console.log('收到消息:', event.data);
};

ws.onerror = (error) => {
  console.error('WebSocket 错误:', error);
};
```

预期结果：
- ✅ WebSocket 连接成功
- ✅ 用户在线状态更新为 ONLINE
- ✅ 断开连接后状态更新为 OFFLINE

### 7. 测试视频调阅功能

#### 7.1 获取录制列表
```bash
curl -X GET "http://localhost:8080/api/v1/video-review/recordings?page=0&size=20" \
  -H "Authorization: Bearer {token}"
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回录制列表（分页）

#### 7.2 获取存储统计
```bash
curl -X GET http://localhost:8080/api/v1/video-review/statistics \
  -H "Authorization: Bearer {token}"
```

预期结果：
- ✅ 返回 200 状态码
- ✅ 返回存储统计信息

### 8. 测试前端管理台

#### 8.1 启动前端
```bash
cd frontend
npm run dev
```

#### 8.2 访问管理台
1. 访问 http://localhost:5173
2. 使用管理员账号登录（admin / admin123）
3. 访问 http://localhost:5173/admin

预期结果：
- ✅ 管理台页面加载成功
- ✅ 显示系统统计信息
- ✅ 侧边栏导航正常
- ✅ 可以切换不同页面

#### 8.3 测试用户管理
1. 点击"用户管理"菜单
2. 查看用户列表
3. 尝试强制下线功能

预期结果：
- ✅ 用户列表加载成功
- ✅ 显示在线状态（不同颜色的 Tag）
- ✅ 强制下线功能正常

#### 8.4 测试会议室管理
1. 点击"会议室管理"菜单
2. 查看会议室列表
3. 尝试强制关闭功能

预期结果：
- ✅ 会议室列表加载成功
- ✅ 显示会议室状态
- ✅ 强制关闭功能正常

## 性能验证

### 1. 数据库查询性能
```sql
-- 检查索引是否创建
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename IN ('users', 'rooms', 'recordings', 'admin_operation_logs');
```

预期结果：
- ✅ 所有必要的索引都已创建

### 2. 并发测试
使用 JMeter 或 Apache Bench 进行并发测试：
```bash
ab -n 1000 -c 10 -H "Authorization: Bearer {token}" \
  http://localhost:8080/api/v1/admin/statistics
```

预期结果：
- ✅ 所有请求成功
- ✅ 平均响应时间 < 100ms

## 安全验证

### 1. 权限控制
- ✅ 非管理员无法访问 `/api/v1/admin/**` 端点
- ✅ 未登录用户无法访问需要认证的端点
- ✅ JWT Token 过期后无法访问

### 2. SQL 注入防护
尝试 SQL 注入攻击：
```bash
curl -X GET "http://localhost:8080/api/v1/admin/users?username=admin' OR '1'='1" \
  -H "Authorization: Bearer {admin_token}"
```

预期结果：
- ✅ 不会返回所有用户
- ✅ 参数被正确转义

### 3. XSS 防护
尝试 XSS 攻击：
```bash
curl -X POST http://localhost:8080/api/rooms \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "roomName": "<script>alert(\"XSS\")</script>"
  }'
```

预期结果：
- ✅ 脚本被转义或过滤
- ✅ 不会执行恶意脚本

## 日志验证

### 1. 检查应用日志
```bash
tail -f backend/videoplat-application/logs/application.log
```

预期结果：
- ✅ 日志格式正确
- ✅ 包含所有关键操作的日志
- ✅ 错误日志包含堆栈信息

### 2. 检查操作日志
```sql
SELECT * FROM admin_operation_logs ORDER BY created_at DESC LIMIT 10;
```

预期结果：
- ✅ 管理员操作被正确记录
- ✅ 包含操作人、操作类型、目标对象、IP 地址等信息

## 文档验证

### 1. API 文档
- ✅ Swagger UI 可访问
- ✅ 所有 API 端点都有文档
- ✅ 参数说明清晰
- ✅ 示例请求和响应完整

### 2. 代码注释
- ✅ 所有类都有 JavaDoc 注释
- ✅ 所有公共方法都有注释
- ✅ 复杂逻辑有详细说明

### 3. README 文档
- ✅ 每个模块都有 README.md
- ✅ 包含模块说明、使用方法、API 端点等
- ✅ 项目根目录有完整的文档

## 验证总结

### 必须通过的验证项
- [ ] 后端编译成功
- [ ] 前端编译成功
- [ ] 数据库迁移成功
- [ ] 应用启动成功
- [ ] 管理员登录成功
- [ ] 管理台 API 正常
- [ ] 权限控制正常
- [ ] WebSocket 连接正常
- [ ] 前端管理台正常

### 建议通过的验证项
- [ ] 性能测试通过
- [ ] 安全测试通过
- [ ] 日志记录完整
- [ ] 文档完整清晰

## 问题排查

### 常见问题

#### 1. 编译失败
- 检查 Maven 版本（需要 3.8+）
- 检查 Java 版本（需要 17+）
- 清理缓存：`mvn clean`

#### 2. 数据库连接失败
- 检查 PostgreSQL 是否启动
- 检查数据库连接配置
- 检查数据库用户权限

#### 3. Redis 连接失败
- 检查 Redis 是否启动
- 检查 Redis 连接配置
- 检查 Redis 密码（如果有）

#### 4. WebSocket 连接失败
- 检查防火墙设置
- 检查 CORS 配置
- 检查 WebSocket 端点配置

#### 5. 前端无法访问后端
- 检查 CORS 配置
- 检查后端是否启动
- 检查前端 API 基础 URL 配置

## 下一步

验证通过后：
1. 删除原 `backend/src/main/java/com/videoplat/` 目录下的已迁移文件
2. 更新 CLAUDE.md 文档
3. 提交代码到 Git
4. 部署到测试环境
5. 进行完整的功能测试

---

**创建时间**：2026-02-08
**版本**：v0.1.0
